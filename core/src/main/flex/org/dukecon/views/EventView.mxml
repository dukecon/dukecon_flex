<?xml version="1.0"?>
<!--
  Created by christoferdutz on 06.07.15.
-->
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009"
        xmlns:s="library://ns.adobe.com/flex/spark"
        xmlns:comp="org.dukecon.components.*"
        xmlns:parsley="http://www.spicefactory.org/parsley">

    <fx:Metadata>
        [ResourceBundle("dukecon")]
    </fx:Metadata>

    <fx:Declarations>
        <parsley:FastInject>
            <parsley:Inject property="conferenceService" type="{ConferenceService}" />
            <parsley:Inject property="speakerService" type="{SpeakerService}" />
            <parsley:Inject property="streamService" type="{StreamService}" />
            <parsley:Inject property="languageService" type="{LanguageService}" />
            <parsley:Inject property="locationService" type="{LocationService}" />
            <parsley:Inject property="ratingService" type="{RatingService}" />
            <!--parsley:Inject property="localUserPreferencesController" type="{LocalUserPreferencesController}" />
            <parsley:Inject property="remoteUserPreferencesController" type="{RemoteUserPreferencesController}" /-->
        </parsley:FastInject>
        <s:DateTimeFormatter id="startTimeFormatter"
                             dateTimePattern="{resourceManager.getString('dukecon', 'dateTime.dateTime')}"/>
        <s:DateTimeFormatter id="endTimeFormatter"
                             dateTimePattern="{resourceManager.getString('dukecon', 'dateTime.time')}"/>
        <s:RadioButtonGroup id="ratingGroup" itemClick="onRatingChanged(event)"/>
    </fx:Declarations>

    <fx:Script>
        <![CDATA[
        import mx.core.UIComponent;
        import mx.events.ItemClickEvent;

        import org.dukecon.model.Event;
        import org.dukecon.model.Speaker;
        import org.dukecon.model.user.UserPreference;
        import org.dukecon.services.ConferenceService;
        import org.dukecon.services.LanguageService;
        import org.dukecon.services.LocationService;
        import org.dukecon.services.RatingService;
        import org.dukecon.services.SpeakerService;
        import org.dukecon.services.StreamService;

        [Bindable]
        protected var featureServerFavorites:Boolean = FEATURE::serverFavorites;

        [Bindable]
        protected var featureEventRating:Boolean = FEATURE::eventRating;

        [Embed(source="/star-unselected.png")]
        [Bindable]
        public var starUnselected:Class;

        [Embed(source="/star-selected.png")]
        [Bindable]
        public var starSelected:Class;

        [Bindable]
        protected var event:org.dukecon.model.Event;

        [Bindable]
        protected var selectedIcon:Class;

        [Bindable]
        protected var streamIcon:Class;

        [Bindable]
        protected var speakers:String;

        [Bindable]
        protected var locationName:String;

        [Bindable]
        protected var streamName:String;

        public var conferenceService:ConferenceService;
        public var speakerService:SpeakerService;
        public var locationService:LocationService;
        public var streamService:StreamService;
        public var languageService:LanguageService;
        public var ratingService:RatingService;


        /*      [Inject]
         public var localUserPreferencesController:LocalUserPreferencesController;

         [Inject]
         public var remoteUserPreferencesController:RemoteUserPreferencesController;
         */
        [Bindable("dataChange")]
        override public function get data():Object {
            return super.data;
        }

        override public function set data(value:Object):void {
            super.data = value;
            event = org.dukecon.model.Event(data);
            update();
        }

        override protected function commitProperties():void {
            super.commitProperties();
            update();
        }

        protected function update():void {
            if (event && speakerService && streamService && languageService) {
                updateSelectionIcon();
                if (event) {
                    streamIcon = streamService.getIconForStream(event.track.id);
                    languageIcon.source = languageService.getIconForLanguage(event.language.id);
                    locationMap.source = locationService.getMapForLocation(event.location.id);
                } else {
                    streamIcon = null;
                    languageIcon.source = null;
                    locationMap.source = null;
                }
                speakers = "";
                if (event.speakers) {
                    for each(var speaker:Speaker in event.speakers) {
                        if (speakers.length > 0) {
                            speakers += ", ";
                        }
                        speakers += speaker.name;
                        if (speaker.company) {
                            speakers += " (" + speaker.company + ")";
                        }
                    }
                }
                title = startTimeFormatter.format(event.start) + " - " + endTimeFormatter.format(event.end);
                ratingGroup.selectedValue = ratingService.getRating(event);
                locationName = locationService.getLocationName(event.location.id, resourceManager.localeChain[0]);
                if (event.track.id) {
                    streamName = streamService.getStreamName(event.track.id, resourceManager.localeChain[0]);
                } else {
                    streamName = null;
                }
            } else {
                streamIcon = null;
                streamName = null;
                languageIcon = null;
                speakers = null;
                locationName = null;
            }
        }

        protected function updateSelectionIcon():void {
            if (event) {
//          selectedIcon = localUserPreferencesController.isEventSelected(event) ? starSelected : starUnselected;
            } else {
                selectedIcon = null;
            }
        }

        protected function toggleSelection(evnt:MouseEvent):void {
            var userPreference:UserPreference = new UserPreference();
            userPreference.eventId = event.id;
            /*        if (localUserPreferencesController.isEventSelected(event)) {
             localUserPreferencesController.del(userPreference);
             } else {
             localUserPreferencesController.add(userPreference);
             }
             updateSelectionIcon();

             if (featureServerFavorites && !remoteUserPreferencesController.connectedToRemote && !remoteUserPreferencesController.infoPopupDisplayed) {
             var confirmDialog:ConfirmDialog = new ConfirmDialog();
             confirmDialog.message = resourceManager.getString('dukecon', 'settings.server-account.confirm-not-server-backed');
             confirmDialog.open(DukeConApplication(FlexGlobals.topLevelApplication), true);
             PopUpManager.centerPopUp(confirmDialog);

             remoteUserPreferencesController.infoPopupDisplayed = true;
             }
             */
        }

        protected function onRatingChanged(evnt:ItemClickEvent):void {
//        conferenceController.setRating(event, Number(ratingGroup.selectedValue))
        }
        ]]>
    </fx:Script>

    <s:navigationContent>
        <s:Button label="&lt;" click="{navigator.popView()}"/>
    </s:navigationContent>

    <s:Scroller width="100%" height="100%" horizontalScrollPolicy="off">
        <s:VGroup width="100%" padding="10" gap="30">
            <s:Group width="100%">
                <s:Rect top="4" left="4" right="4" height="150" radiusX="10" radiusY="10" visible="{event != null}">
                    <s:fill>
                        <s:SolidColor color="0x1AA3B1"/>
                    </s:fill>
                </s:Rect>

                <s:Label id="titleLabel" text="{event.title}" top="20" left="20" width="440" styleName="title"/>

                <s:Rect top="20" right="100" width="64" height="64" visible="{event != null}">
                    <s:fill>
                        <s:SolidColor color="0xffffff"/>
                    </s:fill>
                    <s:stroke>
                        <s:SolidColorStroke color="black"/>
                    </s:stroke>
                </s:Rect>

                <comp:VectorImage source="{streamIcon}" top="22" right="100" width="64" height="64"/>

                <s:Image source="{selectedIcon}" top="20" right="20" click="toggleSelection(event)"/>

                <s:Image id="languageIcon" top="100" right="28" width="48" height="36"/>
            </s:Group>
            <s:Label text="{event.abstractText}" styleName="content" width="{UIComponent(parent).width - 20}"/>
            <s:Label text="{speakers}" width="{UIComponent(parent).width - 20}" fontWeight="bold"/>
            <s:HGroup>
                <s:Label text="{resourceManager.getString('dukecon', 'talks.time')}:" fontWeight="bold"/>
                <s:Label text="{startTimeFormatter.format(event.start)} - {endTimeFormatter.format(event.end)}"
                         styleName="content"/>
            </s:HGroup>
            <s:HGroup>
                <s:Label text="{resourceManager.getString('dukecon', 'talks.stream')}:" fontWeight="bold"/>
                <s:Label text="{streamName}" styleName="content"/>
            </s:HGroup>
            <s:HGroup>
                <s:Label text="{resourceManager.getString('dukecon', 'talks.room')}:" fontWeight="bold"/>
                <s:Label text="{locationName}" styleName="content"/>
            </s:HGroup>
            <s:Image id="locationMap" width="{UIComponent(parent).width - 20}"
                     height="{(UIComponent(parent).width - 20) / 1.5}"/>
            <s:HGroup visible="{featureEventRating}">
                <s:Label text="{resourceManager.getString('dukecon', 'talks.rating')}:" fontWeight="bold"/>
                <s:RadioButton groupName="ratingGroup" value="-1" color="red"
                               skinClass="org.dukecon.skins.ImageRadioButtonSkin"/>
                <s:RadioButton groupName="ratingGroup" value="0" color="#FFA500"
                               skinClass="org.dukecon.skins.ImageRadioButtonSkin"/>
                <s:RadioButton groupName="ratingGroup" value="1" color="green"
                               skinClass="org.dukecon.skins.ImageRadioButtonSkin"/>
            </s:HGroup>
        </s:VGroup>
    </s:Scroller>

</s:View>
